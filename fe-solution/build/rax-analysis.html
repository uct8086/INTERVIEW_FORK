<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>当我谈 Rax 按端拆分代码的时候我谈些什么 | 玩相机的程序员</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="代码和照片本质都是创造，是一种信息的传递。我是玩相机的程序员 axuebin，用键盘和相机记录和分享。">
    <link rel="preload" href="/articles/assets/css/0.styles.fe65aa1c.css" as="style"><link rel="preload" href="/articles/assets/js/app.3cef7185.js" as="script"><link rel="preload" href="/articles/assets/js/2.8d419c10.js" as="script"><link rel="preload" href="/articles/assets/js/18.b9ce9c32.js" as="script"><link rel="preload" href="/articles/assets/js/3.97f21fa0.js" as="script"><link rel="preload" href="/articles/assets/js/4.3f1e58e8.js" as="script"><link rel="prefetch" href="/articles/assets/js/10.9b4f5d4b.js"><link rel="prefetch" href="/articles/assets/js/11.1b1d54cb.js"><link rel="prefetch" href="/articles/assets/js/12.ff2d8f3d.js"><link rel="prefetch" href="/articles/assets/js/13.5319aa25.js"><link rel="prefetch" href="/articles/assets/js/14.a7790fa2.js"><link rel="prefetch" href="/articles/assets/js/15.d92386d7.js"><link rel="prefetch" href="/articles/assets/js/16.3e0dde55.js"><link rel="prefetch" href="/articles/assets/js/17.b09396e6.js"><link rel="prefetch" href="/articles/assets/js/19.311f2327.js"><link rel="prefetch" href="/articles/assets/js/20.ac770832.js"><link rel="prefetch" href="/articles/assets/js/5.1c310da4.js"><link rel="prefetch" href="/articles/assets/js/6.f64c5fbd.js"><link rel="prefetch" href="/articles/assets/js/7.0930e395.js"><link rel="prefetch" href="/articles/assets/js/8.0b9c45cf.js"><link rel="prefetch" href="/articles/assets/js/9.16d00e35.js">
    <link rel="stylesheet" href="/articles/assets/css/0.styles.fe65aa1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/articles/" class="router-link-active home-link"><img src="/articles/assets/img/avatar.jpg" alt="玩相机的程序员" class="logo"> <span class="site-name">玩相机的程序员</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/fe-solution/" class="router-link-active">
          前端工程化
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/fe-interview/">
          前端面试
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          关注我
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <!----></nav></div></div> <!----></header> <aside class="sidebar"><div><div class="ads"><div id="ads_2"><div class="ant-carousel"><div class="slick-slider slick-initialized"><div class="slick-list"><div class="slick-track"><div tabIndex="-1" data-index="0" class="slick-slide slick-active slick-current" style="outline:none;width:null;"><div><div tabIndex="-1" style="width:100%;display:inline-block;"><a target="_blank" rel="noopener noreferrer"><img src="/articles/assets/img/qrcode2.jpg" title="Ads details here"></a></div></div></div></div></div></div></div></div></div> <div role="separator" id="reset-margin" class="ant-divider ant-divider-horizontal ant-divider-dashed"></div></div> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>脚手架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/cli/cra.html" title="create-react-app 核心思路分析" class="sidebar-link">create-react-app 核心思路分析</a></li><li><a href="/articles/fe-solution/cli/vuecli.html" title="Vue CLI 是如何实现的 -- 终端命令行工具篇" class="sidebar-link">Vue CLI 是如何实现的 -- 终端命令行工具篇</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Babel</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/babel/first.html" title="初学 Babel 工作原理" class="sidebar-link">初学 Babel 工作原理</a></li><li><a href="/articles/fe-solution/babel/auto-require.html" title="如何用 Babel 为代码自动引入依赖" class="sidebar-link">如何用 Babel 为代码自动引入依赖</a></li><li><a href="/articles/fe-solution/babel/babel-plugin-import.html" title="简单实现 babel-plugin-import 插件" class="sidebar-link">简单实现 babel-plugin-import 插件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>构建相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/build/rax-analysis.html" aria-current="page" title="当我谈 Rax 按端拆分代码的时候我谈些什么" class="active sidebar-link">当我谈 Rax 按端拆分代码的时候我谈些什么</a></li></ul></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="当我谈-rax-按端拆分代码的时候我谈些什么"><a href="#当我谈-rax-按端拆分代码的时候我谈些什么" class="header-anchor">#</a> 当我谈 Rax 按端拆分代码的时候我谈些什么</h1> <h2 id="写在前面"><a href="#写在前面" class="header-anchor">#</a> 写在前面</h2> <p>Rax 是淘系的一套跨端解决方案。</p> <p>根据 <a href="https://www.yuque.com/hedgqh/de046s/yv19ez" target="_blank" rel="noopener noreferrer">Rax 工程配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 知道，使用 <code>Rax</code> 时，如果设置了 <code>target: ['web', 'weex']</code>，则构建产物 <code>build</code> 目录会有两个子目录：<code>web</code> 和 <code>weex</code>，分别在 <code>web</code> 端和 <code>weex</code> 端消费。并且通过观察可以发现，两个目录下的内容是不一样的，已经根据不同环境拆分代码。业务逻辑比较复杂时，代码体积会比较大，按端拆分代码的能力是必须的。</p> <p>但是在 <code>src</code> 目录中并没有区分 <code>web</code> 和 <code>weex</code> 目录，代码是写到一起的，通过 <code>isWeex</code>  或 <code>isWeb</code> 等环境判断变量来判断。</p> <p>可以思考三个问题：</p> <ol><li>一份代码如何构建出两份不同环境（<code>web</code> 和 <code>weex</code>）的产物？</li> <li>在构建阶段，如何使 <code>web</code> 和 <code>weex</code> 的代码中不存在其他端的冗余代码？</li> <li>为何需要使用 <code>universal-env</code> 导出的 <code>isWeex</code> 和 <code>isWeb</code> 变量，而不能直接在项目中使用 <code>typeof WXEnvironment</code>  来判断？</li></ol> <p><strong>这里只以 weex 举例，其它端表现也是一样的，比如设置了 <code>target: miniapp</code>  则构建产物中会多一个 miniapp 目录。</strong></p> <p>带着这三个问题，我们来看看是否能从 <code>Rax</code> 相关源码里找到答案。</p> <h2 id="举个栗子"><a href="#举个栗子" class="header-anchor">#</a> 举个栗子</h2> <p>如果没有写过 <code>Rax</code>，可能前言里的内容没什么体感，没关系，看一个例子就了解了。</p> <p>代码逻辑很简单，<code>web</code> 下展示 <code>hello web</code> ，<code>weex</code> 下展示 <code>hello weex</code>：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rax'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> View <span class="token keyword">from</span> <span class="token string">'rax-view'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Text <span class="token keyword">from</span> <span class="token string">'rax-text'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isWeex <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'universal-env'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">View</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>home<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Text</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>isWeex <span class="token operator">?</span> <span class="token string">'hello weex'</span> <span class="token operator">:</span> <span class="token string">'hello web'</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Text</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">View</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看一下构建产物：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>├── build
│   ├── web
│   │   ├── index.css
│   │   ├── index.html
│   │   ├── index.js
│   │   ├── pages_home_index.chunk.css
│   │   └── pages_home_index.chunk.js
│   └── weex
│       └── index.js
</code></pre></div><p>weex/index.js</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">Object</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>createElement<span class="token punctuation">)</span><span class="token punctuation">(</span>
    i<span class="token punctuation">.</span>a<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      className<span class="token operator">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">Object</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>createElement<span class="token punctuation">)</span><span class="token punctuation">(</span>
      u<span class="token punctuation">.</span>a<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        className<span class="token operator">:</span> <span class="token string">'title'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'hello weex'</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>web/pages_home_index.chunk.js</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">Object</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>createElement<span class="token punctuation">)</span><span class="token punctuation">(</span>
    o<span class="token punctuation">.</span>a<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      className<span class="token operator">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">Object</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>createElement<span class="token punctuation">)</span><span class="token punctuation">(</span>
      s<span class="token punctuation">.</span>a<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        className<span class="token operator">:</span> <span class="token string">'title'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'hello web'</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 <code>weex</code> 和 <code>web</code> 的构建产物中分别只有 <code>hello weex</code>  和 <code>hello web</code> ，符合我们的预期。</p> <h2 id="源码分析"><a href="#源码分析" class="header-anchor">#</a> 源码分析</h2> <p><code>Rax</code> 也是基于 <code>build-scripts</code> 构建体系来进行构建的，如果还不了解 <code>build-scripts</code>，可以先看一下 <a href="https://github.com/ice-lab/build-scripts" target="_blank" rel="noopener noreferrer">build-scripts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p><code>build-scripts</code> 内部的基础 <code>webpack</code> 配置都是通过 <a href="https://github.com/neutrinojs/webpack-chain" target="_blank" rel="noopener noreferrer">webpack-chain<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 生成的，它通过 <code>webpack</code> 配置链式操作的 API，并可以定义具体 <code>loader</code> 规则和 <code>webpack</code> 插件的名称，可以让开发者更加细粒度修改 <code>webpack</code> 配置。</p></blockquote> <p>了解了 <code>build-scripts</code> 以及它的插件体系之后，我们看一下 <code>Rax</code> app 的核心插件 <code>build-plugin-rax-app</code>，逐一来解决上面的三个问题。代码在这：<a href="https://github.com/raxjs/rax-scripts/tree/master/packages/build-plugin-rax-app" target="_blank" rel="noopener noreferrer">build-plugin-rax-app<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，感兴趣的同学也可以看一眼。</p> <h3 id="build-scripts-是如何构建多个产物"><a href="#build-scripts-是如何构建多个产物" class="header-anchor">#</a> build-scripts 是如何构建多个产物</h3> <p>在 <code>src</code> 下找到了 <code>build.js</code>，看文件名一定是 <code>build</code> 的时候用的 ~</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 以下仅保留构建多个产物的相关代码</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token punctuation">{</span> onGetWebpackConfig<span class="token punctuation">,</span> registerTask<span class="token punctuation">,</span> context<span class="token punctuation">,</span> onHook <span class="token punctuation">}</span><span class="token punctuation">,</span>
  options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> targets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">'spa'</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  targets<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">target</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token constant">WEB</span><span class="token punctuation">,</span> <span class="token constant">WEEX</span><span class="token punctuation">,</span> <span class="token constant">KRAKEN</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> getBase <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./config/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/getBase</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">registerTask</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token function">getBase</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> target<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>插件会遍历 <code>build.json</code> 传入的 <code>targets</code> 字段，注册多个具名 <code>webpack Task</code>，默认配置存储在 <code>config</code> 对应的目录下。
<img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7dc6c81b8a0c42d5aa0908e29e5ebac3~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png">
对比 <code>web/getBase.js</code>  和 <code>weex/getBase.js</code>  发现都有设置 <code>output</code>，<code>output</code> 配置项控制 <code>webpack</code> 如何输出 <code>bundles</code>。</p> <p>看上去 <code>registerTask</code> 只是注册了多份 <code>webpack config</code>，如何被 <code>webpack</code> 消费呢？这就得看一下 <code>build-scripts</code> 里的代码了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 定义 registerTask</span>
<span class="token comment">// 每次运行 registerTask 都会往 configArr 里 push 一次 config</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">registerTask</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> chainConfig</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> exist <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configArr<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> v<span class="token punctuation">.</span>name <span class="token operator">===</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>
      <span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">,</span>
      chainConfig<span class="token punctuation">,</span>
      modifyFunctions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Error] config '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' already exists!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// webpack 使用 config</span>
<span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> configArr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> v<span class="token punctuation">.</span>chainConfig<span class="token punctuation">.</span><span class="token function">toConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> <span class="token function">applyHook</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>command<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.run</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> args<span class="token punctuation">,</span> config<span class="token operator">:</span> webpackConfig <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> compiler<span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// 传入 webpack 一个配置项数组</span>
  compiler <span class="token operator">=</span> <span class="token function">webpackInstance</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里往 <code>webpack</code> 函数里传入一个了配置项数组，对应的就是多个 <code>registerTask</code> 注册的配置项。</p> <p>你一定会好奇，这个配置项数组在 <code>webpack</code> 中是如何被执行的？是一次编译过程还是多次编译过程？是串行还是并行执行？这些问题如果要关心构建速度的话，都是需要了解的。刚好这块儿之前也不了解，就一起看看。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack/lib/webpack.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">webpack</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> compiler<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiCompiler</span><span class="token punctuation">(</span>
      Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">options</span> <span class="token operator">=&gt;</span> <span class="token function">webpack</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 单 options</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 回调</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> compiler<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>从代码上看来应该是会执行多次编译，多次编译过程执行完之后会调用 <code>callback</code>。那多个编译过程是串行的还是并行的呢？</p> <p>先不急着下结论，第六感告诉我得先看看 <code>MultiCompiler</code> 做了啥事。</p> <h4 id="multicompiler-多配置编译"><a href="#multicompiler-多配置编译" class="header-anchor">#</a> MultiCompiler 多配置编译</h4> <p><strong>以下内容涉及到 webpack 的源码，说实话还是第一次看，如果有不对的地方，麻烦大家一定要指出，谢谢。</strong></p> <blockquote><p>The  MultiCompiler module allows webpack to run multiple configurations in separate compilers. If the options parameter in the webpack's NodeJS api is an array of options, webpack applies separate compilers and calls the callback after all compilers have been executed.</p></blockquote> <p>注意关键词： <code>separate compilers</code> ，石锤单独编译，并且是当 <code>all compilers executed</code>  才会调用 <code>callback</code> 。</p> <p><strong>顺便吐槽一下 webpack 的中文文档。。大家还是多看英文文档，以免被误导。。</strong></p> <table><thead><tr><th style="text-align:center;"><strong>这是错的 ❌</strong></th></tr></thead> <tbody><tr><td style="text-align:center;"><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42b853fc906a45e68778bc1ba040a0bb~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></td></tr></tbody></table> <p>那 <code>MultiCompiler</code> 是串行还是并行的呢？官网是这样描述的：</p> <blockquote><p><em>Multiple configurations will <em><strong>not be run in parallel</strong></em>. Each configuration is only processed after the previous one has finished processing.</em></p></blockquote> <p><strong>嗯，串行的，每一次编译会在上一次编译结束之后才会执行</strong>。可以通过 <a href="https://github.com/trivago/parallel-webpack" target="_blank" rel="noopener noreferrer">parallel-webapck<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来并行处理多个 <code>config</code> 的编译。</p> <p>有的人可能有疑问，在使用 <code>rax-app build</code>  的时候，控制台里看到两个端的任务进度条是并行的啊，比如这样：</p> <p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d46ecc5e569420e8c6861405508c7a1~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p> <p>我是这样理解的。上面只是说的 <code>MultiCompiler</code>  是串行的，但是 <code>webpack</code> 是基于 <code>Tapable</code>  的，它整体执行 <code>loader/plugin</code> 的流程都是异步的，相当于 <code>MultiCompiler</code>  只是注册了 <code>compiler</code> 任务，内部的流程都是同时异步在跑的。看一下源码验证一下：</p> <p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/914837c2a6854c73892608faf71de503~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p> <p><code>MultiCompiler</code> 里每个 <code>compiler</code> 都 <code>tap</code>（注册）了 <code>MultiCompiler</code> 事件，完成之后就会执行回调。</p> <p>至于 <code>Tapable</code>，在这里就不展开说了（<s>我也不是很懂，不敢乱说</s>），感兴趣的同学可以看一下 <a href="https://github.com/webpack/tapable" target="_blank" rel="noopener noreferrer">webpack/tapable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>至此，<code>build-scripts</code> 是如何构建多个产物就算是了解清楚了。</p> <p><strong>总结：如果我们需要构建出更多的产物，只需要在插件内部通过 <code>registerTask</code> 注册新的任务，传入对应的 <code>wepack config</code> 即可。</strong></p> <h3 id="rax-app-是如何拆分代码"><a href="#rax-app-是如何拆分代码" class="header-anchor">#</a> Rax app 是如何拆分代码</h3> <p>从上文的例子中知道，我们需要删除的代码是根据端判断之后不会执行到的代码（包括未使用的模块），也就是所有的 <code>Dead Code</code>。目前在构建阶段删除 <code>Dead Code</code> 可以通过以下方式：</p> <ol><li><a href="https://babeljs.io/docs/en/babel-plugin-minify-dead-code-elimination" target="_blank" rel="noopener noreferrer">babel-plugin-minify-dead-code-elimination<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：<code>babel plugin</code>，删除 <code>dead code</code></li> <li><a href="https://github.com/webpack-contrib/terser-webpack-plugin" target="_blank" rel="noopener noreferrer">terser-webpack-plugin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：<code>webpack plugin</code>，删除 <code>dead code</code>、<code>console</code>、注释等</li></ol> <h4 id="defineplugin-移除代码"><a href="#defineplugin-移除代码" class="header-anchor">#</a> DefinePlugin 移除代码</h4> <p>比较常见的一种做法是通过 <code>DefinePlugin</code> 来定义全局变量，<code>webpack</code> 压缩时会将 <code>dead code</code> 移除。</p> <p>直接上代码，最有体感。初始化一个最简 <code>webpack demo</code>。</p> <p>index.js：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> hello <span class="token operator">=</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>isWeex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  hello <span class="token operator">=</span> <span class="token string">'hello weex'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  hello <span class="token operator">=</span> <span class="token string">'hello web'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> hello<span class="token punctuation">;</span>
</code></pre></div><p>webpack.config.js</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    minimize<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      isWeex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>执行 <code>webpack index.js --config webpack.config.js</code> ，得到 <code>bundle.js</code>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">[</span>
  <span class="token comment">/* 0 */</span>
  <span class="token comment">/***/</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">'use strict'</span><span class="token punctuation">;</span>
    __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> hello <span class="token operator">=</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* harmony default export */</span>
    __webpack_exports__<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span> <span class="token operator">=</span> hello<span class="token punctuation">;</span>

    <span class="token comment">/***/</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/******/</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p><code>config</code> 中通过 <code>DefinePlugin</code> 定义了全局变量 <code>isWeex: true</code>，我们预预期是构建时 <code>webpack</code> 将 <code>src/index.js</code> 代码中的 <code>isWeex</code> 都替换成常量 <code>true</code>。<code>bundle.js</code> 符合期望。</p> <p>开启压缩 <code>minimize: true</code> 之后，<code>webpack</code> 会将 <code>dead code</code> 移除：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 为了方便阅读，代码已经格式化</span>
<span class="token punctuation">[</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">'use strict'</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token string">'hello weex'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>default <span class="token operator">=</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>所以，我们可以通过 <code>build-scripts</code> 多产物构建能力 + <code>webpack.DefinePlugin</code> 完成按端的代码拆分，可能是这样：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getWebpackBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 返回基础 config</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取 webpack 各个端的 config</span>
<span class="token keyword">function</span> <span class="token function">getBase</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">getWebpackBase</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> isWeb<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> isWeex<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> <span class="token string">'weex'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> <span class="token punctuation">{</span> isWeb<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> isWeex<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  config<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'DefinePlugin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>webpack<span class="token punctuation">.</span>DefinePlugin<span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token operator">...</span>options<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// build-scripts 插件</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> registerTask <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> targets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'weex'</span><span class="token punctuation">,</span> <span class="token string">'web'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  targets<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">target</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">registerTask</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token function">getBase</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>总结：可以通过 <code>DefinePlugin</code> 在构建时移除无关代码，根据上文 build-scripts 的多产物构建能力，我们是可以在构建阶段构建出移除无关代码的各个端的产物。</strong></p> <p>但是，从上面的代码可以看出，通过 <code>DefinePlugin</code> 来定义全局变量的缺点在于 <code>isWeex</code>、 <code>isWeb</code> 等变量名是直接定义在 <code>webpack</code> 配置里的，扩展性不好，并且在实际业务代码中也需要使用这些变量，似乎约束也太强了。这种约定俗成的东西，随着时间的流逝，可能就慢慢地淡忘了。所以这个方案从长远来看，是不太友好的。</p> <h4 id="universal-env-是必须的"><a href="#universal-env-是必须的" class="header-anchor">#</a> universal-env 是必须的</h4> <p>这里就需要稍微提一下 <a href="https://www.npmjs.com/package/universal-env" target="_blank" rel="noopener noreferrer">universal-env<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这个包了，它的功能很简单，就只是导出各个环境的判断变量，如下：</p> <p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1a1cf1501b1a465c961ae2d935d24731~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <p>但是它的作用不仅仅是这些，它是整个跨端体系中起到至关重要的一环。在前面的例子中也都有看到，一般是通过 <code>import { isWeex} from 'univeral-env'</code>  在业务代码中判断环境。和将全局变量定义在 <code>webpack config</code> 相比，这样的方式扩展性更强，也更易维护。</p> <p>现在的问题就是通过 <code>univeral-env</code> 来导出环境判断变量之后，如何做到代码拆分。</p> <h4 id="babel-移除代码"><a href="#babel-移除代码" class="header-anchor">#</a> Babel 移除代码</h4> <p>既然 <code>webpack</code> 的能力我们没法用，如果想修改代码就只能是通过 <code>Babel</code> 来修改 <code>AST</code> 了。当然，我们今天的主角 <code>Rax</code> 也是这样做的，它通过一个 <code>platformLoader</code> 将 <code>isWeex</code> 等变量在构建阶段替换成常量。</p> <p>本篇文章只关心核心代码（变量 -&gt; 常量）部分，感兴趣的同学可以阅读完整代码：<a href="https://github.com/raxjs/rax-scripts/tree/master/packages/rax-compile-config/src/platformLoader" target="_blank" rel="noopener noreferrer">platformLoader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>定义了一份映射表，<code>target</code> 对应的变量会被置为 <code>true</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> platformMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  weex<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'isWeex'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  web<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'isWeb'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  kraken<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'isKraken'</span><span class="token punctuation">,</span> <span class="token string">'isWeb'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  node<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'isNode'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  miniapp<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'isMiniApp'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">'wechat-miniprogram'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'isWeChatMiniProgram'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>traverseImport</code> 中操作 <code>AST</code> 的代码和以往使用 <code>babel</code> 没啥区别，就不展开说了，简单来说就是：</p> <ol><li>找到 <code>ImportDeclaration</code> 判断是否 <code>import</code> 的 <code>universal-env</code> <ul><li>如果是，判断 import 的 <code>imported.name</code> 是否在上面定义的 <code>map</code> 中
<ul><li>如果在，就创建一个 <code>VariableDeclaration</code> 加到 <code>AST</code> 中，并且移除 <code>ImportDeclaration</code></li></ul></li></ul></li></ol> <p>除了常规操作之外，这里有两个比较有意思的点可以说一下：</p> <h5 id="兼容-commonjs-代码"><a href="#兼容-commonjs-代码" class="header-anchor">#</a> 兼容 CommonJS 代码</h5> <p>如果代码已经被编译过，<code>CommonJS</code> 规范的代码可能已经是这样的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> _universalEnv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'universal-env'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>_universalEnv<span class="token punctuation">.</span>isWeex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'weex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'web'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>platformLoader</code> 是这样处理的：</p> <ol><li>处理引用关系：找到 <code>CallExpression</code>，将它替换为 <code>objectExpression</code> <ul><li>替换前： <code>var _universalEnv = require(&quot;universal-env&quot;)</code></li> <li>替换后： <code>var _universalEnv = {isWeex: false}</code></li></ul></li> <li>处理值：找到 <code>MemberExpression</code>，判断 <code>object.name</code> 是否是 <code>_universalEnv</code> <ul><li>如果是，判断 <code>property.name</code> 是否在上面定义的 <code>map</code> 中
<ul><li>如果在，就设为 <code>true</code>，否则设为 <code>false</code></li></ul></li></ul></li></ol> <h5 id="兼容解构别名"><a href="#兼容解构别名" class="header-anchor">#</a> 兼容解构别名</h5> <p>如果使用 <code>universal-env</code> 的时候，给变量设置了别名呢？</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> isWeex <span class="token keyword">as</span> isWeexPlatform <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'univeral-env'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>isWeexPlatform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>platformLoader</code> 也做了相关处理：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>specObj<span class="token punctuation">.</span>imported <span class="token operator">!==</span> specObj<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  newNode <span class="token operator">=</span> <span class="token function">variableDeclarationMethod</span><span class="token punctuation">(</span>specObj<span class="token punctuation">.</span>local<span class="token punctuation">,</span> newNodeInit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  path<span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span>newNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>总结， platformLoader 实现了我们需要的两个功能：</strong></p> <ol><li>移除 <code>universal-env</code> 依赖</li> <li>将环境变量替换成常量</li></ol> <p>最后通过 <code>webpack</code> 压缩时删除 <code>dead code</code> 的能力就可以将 <code>if(false)</code> 等不会执行到的代码删除，实现拆分代码的功能。</p> <p><strong>所以，如果我们有一个跨端组件，想在纯 <code>web</code> 的工程中使用，也是可以通过 <code>platformLoader</code> 来处理的，不用担心会引入冗余代码，做到基础组件的跨端使用。</strong></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>看完上面的源码分析，上文的三个疑问是否已经有了答案？</p> <p><strong>总结一下</strong></p> <ol><li><code>build-scripts</code> 支持多 <code>config</code> 构建的能力，通过 <code>registerTask</code> 可以注册多个 <code>webpack compiler</code>，它们本身是一个串行过程。<code>compiler</code> 注册之后，它内部的 <code>loader</code> 等过程相比注册 <code>compiler</code> 是异步的</li> <li><code>universal-env</code> 提供统一的环境判断变量，在 <code>Rax</code> 跨端工程化体系中起到至关重要的作用，业务代码中判断环境务必使用其导出的变量</li> <li><code>Rax</code> 是通过其提供的 <code>platformLoader</code> + <code>webpack</code> 压缩能力来实现的代码按端拆分，可以借助这个能力在非 <code>Rax</code> 工程中实现跨端组件的按需打包</li></ol> <h2 id="招聘"><a href="#招聘" class="header-anchor">#</a> 招聘</h2> <p>阿里国际化团队基础架构组招聘前端 P6/P7，base 杭州，基础设施建设，业务赋能... 很多事情可以做。</p> <p>要求熟悉 工程化/ Node/ React... 可直接发送简历至 yibin.xb@alibaba-inc.com，也可以加我微信 <strong>xb9207</strong> 细聊。</p> <div class="article-footer" data-v-4713b8bc><div role="separator" class="ant-divider ant-divider-horizontal" data-v-4713b8bc></div> <p data-v-4713b8bc>
    关注公众号
    <span class="bold" data-v-4713b8bc>玩相机的程序员</span></p> <p data-v-4713b8bc>原创文章持续更新中</p> <img src="/articles/assets/img/qrcode.jpg" data-v-4713b8bc> <p data-v-4713b8bc>我是 axuebin，用键盘和相机记录生活</p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/articles/fe-solution/babel/babel-plugin-import.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        简单实现 babel-plugin-import 插件
      </a></span> <!----></p></div> </main> <!----></div><div class="global-ui"><div class="right-group" data-v-63a47ae2><div class="item" data-v-63a47ae2><div class="title" data-v-63a47ae2>关注微信公众号</div> <div class="desc" data-v-63a47ae2>高质量原创文章</div> <img src="/articles/assets/img/qrcode.jpg" alt="玩相机的程序员" title="玩相机的程序员" data-v-63a47ae2></div> <div class="item" data-v-63a47ae2><div class="title" data-v-63a47ae2>加入前端划水群</div> <div class="desc" data-v-63a47ae2>
      扫码备注
      <span class="red" data-v-63a47ae2>加群</span></div> <img src="/articles/assets/img/wechat.jpg" alt="axuebin" title="axuebin" data-v-63a47ae2></div></div></div></div>
    <script src="/articles/assets/js/app.3cef7185.js" defer></script><script src="/articles/assets/js/2.8d419c10.js" defer></script><script src="/articles/assets/js/18.b9ce9c32.js" defer></script><script src="/articles/assets/js/3.97f21fa0.js" defer></script><script src="/articles/assets/js/4.3f1e58e8.js" defer></script>
  </body>
</html>