<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Vue CLI 是如何实现的 -- 终端命令行工具篇 | 玩相机的程序员</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="代码和照片本质都是创造，是一种信息的传递。我是玩相机的程序员 axuebin，用键盘和相机记录和分享。">
    <link rel="preload" href="/articles/assets/css/0.styles.fe65aa1c.css" as="style"><link rel="preload" href="/articles/assets/js/app.3cef7185.js" as="script"><link rel="preload" href="/articles/assets/js/2.8d419c10.js" as="script"><link rel="preload" href="/articles/assets/js/20.ac770832.js" as="script"><link rel="preload" href="/articles/assets/js/3.97f21fa0.js" as="script"><link rel="preload" href="/articles/assets/js/4.3f1e58e8.js" as="script"><link rel="prefetch" href="/articles/assets/js/10.9b4f5d4b.js"><link rel="prefetch" href="/articles/assets/js/11.1b1d54cb.js"><link rel="prefetch" href="/articles/assets/js/12.ff2d8f3d.js"><link rel="prefetch" href="/articles/assets/js/13.5319aa25.js"><link rel="prefetch" href="/articles/assets/js/14.a7790fa2.js"><link rel="prefetch" href="/articles/assets/js/15.d92386d7.js"><link rel="prefetch" href="/articles/assets/js/16.3e0dde55.js"><link rel="prefetch" href="/articles/assets/js/17.b09396e6.js"><link rel="prefetch" href="/articles/assets/js/18.b9ce9c32.js"><link rel="prefetch" href="/articles/assets/js/19.311f2327.js"><link rel="prefetch" href="/articles/assets/js/5.1c310da4.js"><link rel="prefetch" href="/articles/assets/js/6.f64c5fbd.js"><link rel="prefetch" href="/articles/assets/js/7.0930e395.js"><link rel="prefetch" href="/articles/assets/js/8.0b9c45cf.js"><link rel="prefetch" href="/articles/assets/js/9.16d00e35.js">
    <link rel="stylesheet" href="/articles/assets/css/0.styles.fe65aa1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/articles/" class="router-link-active home-link"><img src="/articles/assets/img/avatar.jpg" alt="玩相机的程序员" class="logo"> <span class="site-name">玩相机的程序员</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/fe-solution/" class="router-link-active">
          前端工程化
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/articles/fe-interview/">
          前端面试
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          关注我
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <!----></nav></div></div> <!----></header> <aside class="sidebar"><div><div class="ads"><div id="ads_2"><div class="ant-carousel"><div class="slick-slider slick-initialized"><div class="slick-list"><div class="slick-track"><div tabIndex="-1" data-index="0" class="slick-slide slick-active slick-current" style="outline:none;width:null;"><div><div tabIndex="-1" style="width:100%;display:inline-block;"><a target="_blank" rel="noopener noreferrer"><img src="/articles/assets/img/qrcode2.jpg" title="Ads details here"></a></div></div></div></div></div></div></div></div></div> <div role="separator" id="reset-margin" class="ant-divider ant-divider-horizontal ant-divider-dashed"></div></div> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>脚手架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/cli/cra.html" title="create-react-app 核心思路分析" class="sidebar-link">create-react-app 核心思路分析</a></li><li><a href="/articles/fe-solution/cli/vuecli.html" aria-current="page" title="Vue CLI 是如何实现的 -- 终端命令行工具篇" class="active sidebar-link">Vue CLI 是如何实现的 -- 终端命令行工具篇</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Babel</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/babel/first.html" title="初学 Babel 工作原理" class="sidebar-link">初学 Babel 工作原理</a></li><li><a href="/articles/fe-solution/babel/auto-require.html" title="如何用 Babel 为代码自动引入依赖" class="sidebar-link">如何用 Babel 为代码自动引入依赖</a></li><li><a href="/articles/fe-solution/babel/babel-plugin-import.html" title="简单实现 babel-plugin-import 插件" class="sidebar-link">简单实现 babel-plugin-import 插件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>构建相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/fe-solution/build/rax-analysis.html" title="当我谈 Rax 按端拆分代码的时候我谈些什么" class="sidebar-link">当我谈 Rax 按端拆分代码的时候我谈些什么</a></li></ul></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="vue-cli-是如何实现的-终端命令行工具篇"><a href="#vue-cli-是如何实现的-终端命令行工具篇" class="header-anchor">#</a> Vue CLI 是如何实现的 -- 终端命令行工具篇</h1> <p><img src="https://imgkr2.cn-bj.ufileos.com/60decb30-034c-4f15-83b3-cebcf21d82bc.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=SAQo5wO9Qwvb6jkuXUWMeJUmBYk%253D&amp;Expires=1610342376" alt=""></p> <p>Vue CLI 是一个基于 Vue.js 进行快速开发的完整系统，提供了终端命令行工具、零配置脚手架、插件体系、图形化管理界面等。本文暂且只分析<strong>项目初始化</strong>部分，也就是终端命令行工具的实现。</p> <h2 id="_0-用法"><a href="#_0-用法" class="header-anchor">#</a> 0. 用法</h2> <p>用法很简单，每个 CLI 都大同小异：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> -g @vue/cli
vue create vue-cli-test
</code></pre></div><p>目前 Vue CLI 同时支持 Vue 2 和 Vue 3 项目的创建（默认配置）。</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/8281719b-9abe-4d94-ac12-d816f33c40d0.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=TXucx0zOmRh02xuTVJp6ZEa1ZEE%253D&amp;Expires=1610341414" alt=""></p> <p>上面是 Vue CLI 提供的默认配置，可以快速地创建一个项目。除此之外，也可以根据自己的项目需求（是否使用 Babel、是否使用 TS 等）来自定义项目工程配置，这样会更加的灵活。</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/c831efd3-9485-49ee-af0b-4a256e731995.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=KLm2xgJ%252FOwNl%252F%252BguxH%252BI8pHdaMQ%253D&amp;Expires=1610341429" alt=""></p> <p>选择完成之后，敲下回车，就开始执行安装依赖、拷贝模板等命令...</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/dbecefb5-608b-4ed7-9273-642eee1ae47a.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=xqkgUjMgzYMNcYjHJnV8V8EPCdE%253D&amp;Expires=1610341471" alt=""></p> <p>看到 Successfully 就是项目初始化成功了。</p> <p><code>vue create</code>  命令支持一些参数配置，可以通过 <code>vue create --help</code>  获取详细的文档：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>用法：create <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">&lt;</span>app-name<span class="token operator">&gt;</span>

选项：
  -p, --preset <span class="token operator">&lt;</span>presetName<span class="token operator">&gt;</span>       忽略提示符并使用已保存的或远程的预设选项
  -d, --default                   忽略提示符并使用默认预设选项
  -i, --inlinePreset <span class="token operator">&lt;</span>json<span class="token operator">&gt;</span>       忽略提示符并使用内联的 JSON 字符串预设选项
  -m, --packageManager <span class="token operator">&lt;</span>command<span class="token operator">&gt;</span>  在安装依赖时使用指定的 <span class="token function">npm</span> 客户端
  -r, --registry <span class="token operator">&lt;</span>url<span class="token operator">&gt;</span>            在安装依赖时使用指定的 <span class="token function">npm</span> registry
  -g, --git <span class="token punctuation">[</span>message<span class="token punctuation">]</span>             强制 / 跳过 <span class="token function">git</span> 初始化，并可选的指定初始化提交信息
  -n, --no-git                    跳过 <span class="token function">git</span> 初始化
  -f, --force                     覆写目标目录可能存在的配置
  -c, --clone                     使用 <span class="token function">git</span> clone 获取远程预设选项
  -x, --proxy                     使用指定的代理创建项目
  -b, --bare                      创建项目时省略默认组件中的新手指导信息
  -h, --help                      输出使用帮助信息
</code></pre></div><p>具体的用法大家感兴趣的可以尝试一下，这里就不展开了，后续在源码分析中会有相应的部分提到。</p> <h2 id="_1-入口文件"><a href="#_1-入口文件" class="header-anchor">#</a> 1. 入口文件</h2> <blockquote><p>本文中的 <code>vue cli</code> 版本为 <code>4.5.9</code>。若阅读本文时存在 <code>break change</code>，可能就需要自己理解一下啦</p></blockquote> <p>按照正常逻辑，我们在 <code>package.json</code> 里找到了入口文件：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;vue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bin/vue.js&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>bin/vue.js</code> 里的代码不少，无非就是在 <code>vue</code>  上注册了 <code>create</code> / <code>add</code> / <code>ui</code>  等命令，本文只分析 <code>create</code>  部分，找到这部分代码（删除主流程无关的代码后）：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 检查 node 版本</span>
<span class="token function">checkNodeVersion</span><span class="token punctuation">(</span>requiredVersion<span class="token punctuation">,</span> <span class="token string">'@vue/cli'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 挂载 create 命令</span>
program<span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'create &lt;app-name&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> cmd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取额外参数</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">cleanArgs</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行 create 方法</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/create'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>cleanArgs</code>  是获取 <code>vue create</code>  后面通过 <code>-</code>  传入的参数，通过 <code>vue create --help</code> 可以获取执行的参数列表。</p> <p>获取参数之后就是执行真正的 <code>create</code>  方法了，等等仔细展开。</p> <p>不得不说，Vue CLI 对于代码模块的管理非常细，每个模块基本上都是<strong>单一功能模块</strong>，可以任意地拼装和使用。每个文件的代码行数也都不会很多，阅读起来非常舒服。</p> <h2 id="_2-输入命令有误-猜测用户意图"><a href="#_2-输入命令有误-猜测用户意图" class="header-anchor">#</a> 2. 输入命令有误，猜测用户意图</h2> <p>Vue CLI 中比较有意思的一个地方，如果用户在终端中输入 <code>vue creat xxx</code>  而不是 <code>vue create xxx</code>，会怎么样呢？理论上应该是报错了。</p> <p>如果只是报错，那我就不提了。看看结果：
<img src="https://imgkr2.cn-bj.ufileos.com/c3198a17-45ab-40d0-9bc2-094328cef331.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=iGl9SOdnXs4YKSHUgZyNi1BHg6w%253D&amp;Expires=1610341481" alt=""></p> <p>终端上输出了一行很关键的信息 <code>Did you mean create</code>，Vue CLI 似乎知道用户是想使用 <code>create</code>  但是手速太快打错单词了。</p> <p>这是如何做到的呢？我们在源代码中寻找答案：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> leven <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'leven'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 如果不是当前已挂载的命令，会猜测用户意图</span>
program<span class="token punctuation">.</span><span class="token function">arguments</span><span class="token punctuation">(</span><span class="token string">'&lt;command&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token parameter">cmd</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">suggestCommands</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 猜测用户意图</span>
<span class="token keyword">function</span> <span class="token function">suggestCommands</span><span class="token punctuation">(</span><span class="token parameter">unknownCommand</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> availableCommands <span class="token operator">=</span> program<span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">cmd</span> <span class="token operator">=&gt;</span> cmd<span class="token punctuation">.</span>_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> suggestion<span class="token punctuation">;</span>

  availableCommands<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cmd</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isBestMatch <span class="token operator">=</span>
      <span class="token function">leven</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> unknownCommand<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">leven</span><span class="token punctuation">(</span>suggestion <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span> unknownCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">leven</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> unknownCommand<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> isBestMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      suggestion <span class="token operator">=</span> cmd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>suggestion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Did you mean </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span>suggestion<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码中使用了 <a href="https://github.com/sindresorhus/leven" target="_blank" rel="noopener noreferrer">leven<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 了这个包，这是用于计算字符串编辑距离算法的 JS 实现，Vue CLI 这里使用了这个包，来分别计算输入的命令和当前已挂载的所有命令的编辑举例，从而猜测用户实际想输入的命令是哪个。</p> <p>小而美的一个功能，用户体验极大提升。</p> <h2 id="_3-node-版本相关检查"><a href="#_3-node-版本相关检查" class="header-anchor">#</a> 3. Node 版本相关检查</h2> <h3 id="_3-1-node-期望版本"><a href="#_3-1-node-期望版本" class="header-anchor">#</a> 3.1 Node 期望版本</h3> <p>和 <code>create-react-app</code>  类似，Vue CLI 也是先检查了一下当前 Node 版本是否符合要求：</p> <ul><li>当前 Node 版本： <code>process.version</code></li> <li>期望的 Node 版本： <code>require(&quot;../package.json&quot;).engines.node</code></li></ul> <p>比如我目前在用的是 Node v10.20.1 而 @vue/cli 4.5.9  要求的 Node 版本是 <code>&gt;=8.9</code>，所以是符合要求的。</p> <h3 id="_3-2-推荐-node-lts-版本"><a href="#_3-2-推荐-node-lts-版本" class="header-anchor">#</a> 3.2 推荐 Node LTS 版本</h3> <p>在 <code>bin/vue.js</code>  中有这样一段代码，看上去也是在检查 Node 版本：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">EOL_NODE_MAJORS</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'8.x'</span><span class="token punctuation">,</span> <span class="token string">'9.x'</span><span class="token punctuation">,</span> <span class="token string">'11.x'</span><span class="token punctuation">,</span> <span class="token string">'13.x'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> major <span class="token keyword">of</span> <span class="token constant">EOL_NODE_MAJORS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>semver<span class="token punctuation">.</span><span class="token function">satisfies</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>version<span class="token punctuation">,</span> major<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You are using Node </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Node.js </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>major<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> has already reached end-of-life and will not be supported in future major releases.\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">It's strongly recommended to use an active LTS version instead.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可能并不是所有人都了解它的作用，在这里稍微科普一下。</p> <p>简单来说，Node 的主版本分为<strong>奇数版本</strong>和<strong>偶数版本</strong>。每个版本发布之后会持续六个月的时间，六个月之后，奇数版本将变为 <strong>EOL</strong> 状态，而偶数版本变为 **Active LTS **状态并且长期支持。所以我们在生产环境使用 Node 的时候，应该尽量使用它的 LTS 版本，而不是 <strong>EOL</strong> 的版本。</p> <blockquote><p>EOL 版本：A End-Of-Life version of Node
LTS 版本: A long-term supported version of Node</p></blockquote> <p>这是目前常见的 Node 版本的一个情况：</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/659f2f2c-0d8e-4fd8-9827-cd2351c2ce7c.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=d0GD6xnBy%252F8gqU7slBGLAcYoLSw%253D&amp;Expires=1610341549" alt=""></p> <p>解释一下图中几个状态：</p> <ul><li><strong>CURRENT</strong>：会修复 bug，增加新特性，不断改善</li> <li><strong>ACTIVE</strong>：长期稳定版本</li> <li><strong>MAINTENANCE</strong>：只会修复 bug，不会再有新的特性增加</li> <li><strong>EOL</strong>：当进度条走完，这个版本也就不再维护和支持了</li></ul> <p>通过上面那张图，我们可以看到，Node 8.x 在 2020 年已经 <strong>EOL</strong>，Node 12.x 在 2021 年的时候也会进入 **MAINTENANCE **状态，而 Node 10.x 在 2021 年 4、5 月的时候就会变成 <strong>EOL</strong>。</p> <p>Vue CLI 中对当前的 Node 版本进行判断，如果你用的是 EOL 版本，会推荐你使用 LTS 版本。也就是说，在不久之后，这里的应该判断会多出一个 <code>10.x</code>，还不快去给 Vue CLI 提个 PR（手动狗头）。</p> <h2 id="_4-判断是否在当前路径"><a href="#_4-判断是否在当前路径" class="header-anchor">#</a> 4. 判断是否在当前路径</h2> <p>在执行 <code>vue create</code>  的时候，是必须指定一个 <code>app-name</code> ，否则会报错： <code>Missing required argument &lt;app-name&gt;</code> 。</p> <p>那如果用户已经自己创建了一个目录，想在当前这个空目录下创建一个项目呢？当然，Vue CLI 也是支持的，执行 <code>vue create .</code>  就 OK 了。</p> <p><code>lib/create.js</code>  中就有相关代码是在处理这个逻辑的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">projectName<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断传入的 projectName 是否是 .</span>
  <span class="token keyword">const</span> inCurrent <span class="token operator">=</span> projectName <span class="token operator">===</span> <span class="token string">'.'</span><span class="token punctuation">;</span>
  <span class="token comment">// path.relative 会返回第一个参数到第二个参数的相对路径</span>
  <span class="token comment">// 这里就是用来获取当前目录的目录名</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> inCurrent <span class="token operator">?</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token string">'../'</span><span class="token punctuation">,</span> cwd<span class="token punctuation">)</span> <span class="token operator">:</span> projectName<span class="token punctuation">;</span>
  <span class="token comment">// 最终初始化项目的路径</span>
  <span class="token keyword">const</span> targetDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> projectName <span class="token operator">||</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果你需要实现一个 CLI，这个逻辑是可以拿来即用的。</p> <h2 id="_5-检查应用名"><a href="#_5-检查应用名" class="header-anchor">#</a> 5. 检查应用名</h2> <p>Vue CLI 会通过 <code>validate-npm-package-name</code>  这个包来检查输入的 <code>projectName</code> 是否符合规范。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">validateProjectName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>validForNewPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid project name: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对应的 <code>npm</code> 命名规范可以见：<a href="https://www.npmjs.com/package/validate-npm-package-name#naming-rules" target="_blank" rel="noopener noreferrer">Naming Rules<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_6-若目标文件夹已存在-是否覆盖"><a href="#_6-若目标文件夹已存在-是否覆盖" class="header-anchor">#</a> 6. 若目标文件夹已存在，是否覆盖</h2> <p>这段代码比较简单，就是判断 <code>target</code>  目录是否存在，然后通过交互询问用户是否覆盖（对应的是操作是删除原目录）：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 是否 vue create -m</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>targetDir<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>merge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 是否 vue create -f</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>targetDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">clearConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果是初始化在当前路径，就只是确认一下是否在当前目录创建</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inCurrent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> ok <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'ok'</span><span class="token punctuation">,</span>
          type<span class="token operator">:</span> <span class="token string">'confirm'</span><span class="token punctuation">,</span>
          message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Generate project in current directory?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果有目标目录，则询问如何处理：Overwrite / Merge / Cancel</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> action <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'action'</span><span class="token punctuation">,</span>
          type<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
          message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Target directory </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span>
            targetDir
          <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> already exists. Pick an action:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          choices<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Overwrite'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">'overwrite'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Merge'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">'merge'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Cancel'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果选择 Cancel，则直接中止</span>
      <span class="token comment">// 如果选择 Overwrite，则先删除原目录</span>
      <span class="token comment">// 如果选择 Merge，不用预处理啥</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">===</span> <span class="token string">'overwrite'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nRemoving </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span>targetDir<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>targetDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_7-整体错误捕获"><a href="#_7-整体错误捕获" class="header-anchor">#</a> 7. 整体错误捕获</h2> <p>在 <code>create</code>  方法的最外层，放了一个 <code>catch</code>  方法，捕获内部所有抛出的错误，将当前的 <code>spinner</code>  状态停止，退出进程。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">stopSpinner</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// do not persist</span>
    <span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_TEST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_8-creator-类"><a href="#_8-creator-类" class="header-anchor">#</a> 8. Creator 类</h2> <p>在 <code>lib/create.js</code>  方法的最后，执行了这样两行代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> creator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Creator</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> targetDir<span class="token punctuation">,</span> <span class="token function">getPromptModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> creator<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>看来最重要的代码还是在 <code>Creator</code>  这个类中。</p> <p>打开 <code>Creator.js</code>  文件，好家伙，500+ 行代码，并且引入了 12 个模块。当然，这篇文章不会把这 500 行代码和 12 个模块都理一遍，没必要，感兴趣的自己去看看好了。</p> <p>本文还是梳理主流程和一些有意思的功能。</p> <h3 id="_8-1-constructor-构造函数"><a href="#_8-1-constructor-构造函数" class="header-anchor">#</a> 8.1 constructor 构造函数</h3> <p>先看一下 <code>Creator</code>  类的的构造函数：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Creator</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> promptModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_CONTEXT</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token comment">// 获取了 preset 和 feature 的 交互选择列表，在 vue create 的时候提供选择</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> presetPrompt<span class="token punctuation">,</span> featurePrompt <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveIntroPrompts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>presetPrompt <span class="token operator">=</span> presetPrompt<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>featurePrompt <span class="token operator">=</span> featurePrompt<span class="token punctuation">;</span>

    <span class="token comment">// 交互选择列表：是否输出一些文件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>outroPrompts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveOutroPrompts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>injectedPrompts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>promptCompleteCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>afterInvokeCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>afterAnyInvokeCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>run <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> promptAPI <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PromptModuleAPI</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将默认的一些配置注入到交互列表中</span>
    promptModules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token function">m</span><span class="token punctuation">(</span>promptAPI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>构造函数嘛，主要就是初始化一些变量。这里主要将逻辑都封装在 <code>resolveIntroPrompts</code> / <code>resolveOutroPrompts</code>  和 <code>PromptModuleAPI</code>  这几个方法中。</p> <p>主要看一下 <code>PromptModuleAPI</code> 这个类是干什么的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">PromptModuleAPI</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">creator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>creator <span class="token operator">=</span> creator<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 在 promptModules 里用</span>
  <span class="token function">injectFeature</span><span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>creator<span class="token punctuation">.</span>featurePrompt<span class="token punctuation">.</span>choices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 在 promptModules 里用</span>
  <span class="token function">injectPrompt</span><span class="token punctuation">(</span><span class="token parameter">prompt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>creator<span class="token punctuation">.</span>injectedPrompts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 在 promptModules 里用</span>
  <span class="token function">injectOptionForPrompt</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>creator<span class="token punctuation">.</span>injectedPrompts
      <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">f</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> f<span class="token punctuation">.</span>name <span class="token operator">===</span> name<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>choices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 在 promptModules 里用</span>
  <span class="token function">onPromptComplete</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>creator<span class="token punctuation">.</span>promptCompleteCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这里我们也简单说一下，<code>promptModules</code>  返回的是所有用于终端交互的模块，其中会调用 <code>injectFeature</code> 和 <code>injectPrompt</code> 来将交互配置插入进去，并且会通过 <code>onPromptComplete</code>  注册一个回调。</p> <p><code>onPromptComplete</code> 注册回调的形式是往 <code>promptCompleteCbs</code> 这个数组中 <code>push</code> 了传入的方法，可以猜测在所有交互完成之后应该会通过以下形式来调用回调：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>promptCompleteCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span>answers<span class="token punctuation">,</span> preset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>回过来看这段代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Creator</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> promptModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> promptAPI <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PromptModuleAPI</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    promptModules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token function">m</span><span class="token punctuation">(</span>promptAPI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在 <code>Creator</code>  的构造函数中，实例化了一个 <code>promptAPI</code>  对象，并遍历 <code>prmptModules</code>  把这个对象传入了 <code>promptModules</code>  中，说明在实例化 <code>Creator</code>  的时候时候就会把所有用于交互的配置注册好了。</p> <p>这里我们注意到，在构造函数中出现了四种 <code>prompt</code>： <code>presetPrompt</code>，<code>featurePrompt</code>， <code>injectedPrompts</code>， <code>outroPrompts</code>，具体有什么区别呢？下文有有详细展开。</p> <h3 id="_8-2-eventemitter-事件模块"><a href="#_8-2-eventemitter-事件模块" class="header-anchor">#</a> 8.2 EventEmitter 事件模块</h3> <p>首先， <code>Creator</code>  类是继承于 Node.js 的 <code>EventEmitter</code> 类。众所周知， <code>events</code>  是 Node.js 中最重要的一个模块，而 <code>EventEmitter</code> 类就是其基础，是 Node.js 中事件触发与事件监听等功能的封装。</p> <p>在这里， <code>Creator</code>  继承自 <code>EventEmitter</code> , 应该就是为了方便在 <code>create</code>  过程中 <code>emit</code>  一些事件，整理了一下，主要就是以下 8 个事件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'creation'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">'creating'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'creation'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">'git-init'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化 git</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'creation'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">'plugins-install'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 安装插件</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'creation'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">'invoking-generators'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用 generator</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'creation'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">'deps-install'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 安装额外的依赖</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'creation'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">'completion-hooks'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完成之后的回调</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'creation'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">'done'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// create 流程结束</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'creation'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">'fetch-remote-preset'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拉取远程 preset</span>
</code></pre></div><p>我们知道事件 <code>emit</code>  一定会有 <code>on</code>  的地方，是哪呢？搜了一下源码，是在 @vue/cli-ui 这个包里，也就是说在终端命令行工具的场景下，不会触发到这些事件，这里简单了解一下即可：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> creator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Creator</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> cwd<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPromptModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function-variable function">onCreationEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  progress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token constant">PROGRESS_ID</span><span class="token punctuation">,</span> status<span class="token operator">:</span> event<span class="token punctuation">,</span> info<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
creator<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'creation'</span><span class="token punctuation">,</span> onCreationEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>简单来说，就是通过 <code>vue ui</code>  启动一个图形化界面来初始化项目时，会启动一个 <code>server</code> 端，和终端之间是存在通信的。 <code>server</code> 端挂载了一些事件，在 create 的每个阶段，会从 cli 中的方法触发这些事件。</p> <h2 id="_9-preset-预设"><a href="#_9-preset-预设" class="header-anchor">#</a> 9. Preset（预设）</h2> <p><code>Creator</code>  类的实例方法 <code>create</code>  接受两个参数：</p> <ul><li><strong>cliOptions</strong>：终端命令行传入的参数</li> <li><strong>preset</strong>：Vue CLI 的预设</li></ul> <h3 id="_9-1-什么是-preset-预设"><a href="#_9-1-什么是-preset-预设" class="header-anchor">#</a> 9.1 什么是 Preset（预设）</h3> <p><a href="https://cli.vuejs.org/zh/guide/plugins-and-presets.html#preset" target="_blank" rel="noopener noreferrer">Preset<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是什么呢？官方解释<strong>是一个包含创建新项目所需预定义选项和插件的 JSON 对象，让用户无需在命令提示中选择它们</strong>。比如：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;useConfigFiles&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;cssPreprocessor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sass&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@vue/cli-plugin-babel&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@vue/cli-plugin-eslint&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;config&quot;</span><span class="token operator">:</span> <span class="token string">&quot;airbnb&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;lintOn&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;save&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;commit&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;configs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;vue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;postcss&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;eslintConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 CLI 中允许使用本地的 preset 和远程的 preset。</p> <h3 id="_9-2-prompt"><a href="#_9-2-prompt" class="header-anchor">#</a> 9.2 prompt</h3> <p>用过 <code>inquirer</code> 的朋友的对 prompt 这个单词一定不陌生，它有 <code>input</code> / <code>checkbox</code> 等类型，是用户和终端的交互。</p> <p>我们回过头来看一下在 <code>Creator</code> 中的一个方法 <code>getPromptModules</code>， 按照字面意思，这个方法是获取了一些用于交互的模块，具体来看一下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">getPromptModules</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string">'vueVersion'</span><span class="token punctuation">,</span>
    <span class="token string">'babel'</span><span class="token punctuation">,</span>
    <span class="token string">'typescript'</span><span class="token punctuation">,</span>
    <span class="token string">'pwa'</span><span class="token punctuation">,</span>
    <span class="token string">'router'</span><span class="token punctuation">,</span>
    <span class="token string">'vuex'</span><span class="token punctuation">,</span>
    <span class="token string">'cssPreprocessors'</span><span class="token punctuation">,</span>
    <span class="token string">'linter'</span><span class="token punctuation">,</span>
    <span class="token string">'unit'</span><span class="token punctuation">,</span>
    <span class="token string">'e2e'</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../promptModules/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>看样子是获取了一系列的模块，返回了一个数组。我看了一下这里列的几个模块，代码格式基本都是统一的：：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">cli</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  cli<span class="token punctuation">.</span><span class="token function">injectFeature</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    value<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    short<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    description<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    link<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    checked<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  cli<span class="token punctuation">.</span><span class="token function">injectPrompt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token function-variable function">when</span><span class="token operator">:</span> <span class="token parameter">answers</span> <span class="token operator">=&gt;</span> answers<span class="token punctuation">.</span>features<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
    choices<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  cli<span class="token punctuation">.</span><span class="token function">onPromptComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">answers<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>单独看 <code>injectFeature</code> 和 <code>injectPrompt</code> 的对象是不是和 <code>inquirer</code> 有那么一点神似？是的，他们就是用户交互的一些配置选项。那 Feature  和 Prompt  有什么区别呢？</p> <p><strong>Feature</strong>：Vue CLI 在选择自定义配置时的顶层选项：</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/073f0c67-f590-428d-b7ef-a95451f433df.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=Gp%252FVA40nPzHtGdM1fErN%252FFDKFLI%253D&amp;Expires=1610341573" alt=""></p> <p><strong>Prompt</strong>：选择具体 Feature 对应的二级选项，比如选择了 <strong>Choose Vue version</strong> 这个 Feature，会要求用户选择是 2.x 还是 3.x：</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/65ca9010-916f-4483-bfe5-5f4694de60fc.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=YLLbQZvctuTs1loxx61vzxH2etA%253D&amp;Expires=1610341584" alt=""></p> <p><code>onPromptComplete</code> 注册了一个回调方法，在完成交互之后执行。</p> <p>看来我们的猜测是对的， <code>getPromptModules</code> 方法就是获取一些<strong>用于和用户交互的模块</strong>，比如：</p> <ul><li><strong>babel</strong>：选择是否使用 Babel</li> <li><strong>cssPreprocessors</strong>：选择 CSS 的预处理器（Sass、Less、Stylus）</li> <li>...</li></ul> <p>先说到这里，后面在自定义配置加载的章节里会展开介绍 Vue CLI 用到的所有 <code>prompt</code> 。</p> <h3 id="_9-3-获取预设"><a href="#_9-3-获取预设" class="header-anchor">#</a> 9.3 获取预设</h3> <p>我们具体来看一下获取预设相关的逻辑。这部分代码在 <code>create</code>  实例方法中：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Creator.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Creator</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">cliOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> preset <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isTestOrDebug <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_TEST</span> <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_DEBUG</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> run<span class="token punctuation">,</span> name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> afterInvokeCbs<span class="token punctuation">,</span> afterAnyInvokeCbs <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>preset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cliOptions<span class="token punctuation">.</span>preset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// vue create foo --preset bar</span>
        preset <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePreset</span><span class="token punctuation">(</span>cliOptions<span class="token punctuation">.</span>preset<span class="token punctuation">,</span> cliOptions<span class="token punctuation">.</span>clone<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cliOptions<span class="token punctuation">.</span>default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// vue create foo --default</span>
        preset <span class="token operator">=</span> defaults<span class="token punctuation">.</span>presets<span class="token punctuation">.</span>default<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cliOptions<span class="token punctuation">.</span>inlinePreset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// vue create foo --inlinePreset {...}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          preset <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>cliOptions<span class="token punctuation">.</span>inlinePreset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">error</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">CLI inline preset is not valid JSON: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cliOptions<span class="token punctuation">.</span>inlinePreset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        preset <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">promptAndResolvePreset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到，代码中分别针对几种情况作了处理：</p> <ul><li>cli 参数配了 --preset</li> <li>cli 参数配了 --default</li> <li>cli 参数配了 --inlinePreset</li> <li>cli 没配相关参数，默认获取 <code>Preset</code> 的行为</li></ul> <p>前三种情况就不展开说了，我们来看一下第四种情况，也就是默认通过交互 <code>prompt</code>  来获取 <code>Preset</code> 的逻辑，也就是 <code>promptAndResolvePreset</code>  方法。</p> <p>先看一下实际用的时候是什么样的：</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/9a8ecdd5-95cf-4136-b4e3-72af27f84887.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=NCQJjRnsWPiLfdXIPuCg6%252F5SzJ8%253D&amp;Expires=1610341604" alt=""></p> <p>我们可以猜测这里就是一段 <code>const answers = await inquirer.prompt([])</code>  代码。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">async</span> <span class="token function">promptAndResolvePreset</span><span class="token punctuation">(</span><span class="token parameter">answers <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// prompt</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>answers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">clearConsole</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      answers <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveFinalPrompts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;vue-cli:answers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>answers<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token function">resolveFinalPrompts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>injectedPrompts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prompt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> originalWhen <span class="token operator">=</span> prompt<span class="token punctuation">.</span>when <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      prompt<span class="token punctuation">.</span><span class="token function-variable function">when</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">answers</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">isManualMode</span><span class="token punctuation">(</span>answers<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">originalWhen</span><span class="token punctuation">(</span>answers<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> prompts <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>presetPrompt<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>featurePrompt<span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>injectedPrompts<span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>outroPrompts<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;vue-cli:prompts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>prompts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> prompts<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>是的，我们猜的没错，将 <code>this.resolveFinalPrompts</code>  里的配置进行交互，而 <code>this.resolveFinalPrompts</code>  方法其实就是将在 <code>Creator</code>  的构造函数里初始化的那些 <code>prompts</code>  合到一起了。上文也提到了有这四种 <code>prompt</code>，在下一节展开介绍。
**</p> <h3 id="_9-4-保存预设"><a href="#_9-4-保存预设" class="header-anchor">#</a> 9.4 保存预设</h3> <p>在 Vue CLI 的最后，会让用户选择 <code>save this as a preset for future?</code>，如果用户选择了 <code>Yes</code>，就会执行相关逻辑将这次的交互结果保存下来。这部分逻辑也是在 <code>promptAndResolvePreset</code> 中。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token function">promptAndResolvePreset</span><span class="token punctuation">(</span><span class="token parameter">answers <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    answers<span class="token punctuation">.</span>save <span class="token operator">&amp;&amp;</span>
    answers<span class="token punctuation">.</span>saveName <span class="token operator">&amp;&amp;</span>
    <span class="token function">savePreset</span><span class="token punctuation">(</span>answers<span class="token punctuation">.</span>saveName<span class="token punctuation">,</span> preset<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">log</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">🎉  Preset </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span>answers<span class="token punctuation">.</span>saveName<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> saved in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span>
        rcPath
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在调用 <code>savePreset</code> 之前还会对预设进行解析、校验等，就不展开了，直接来看一下 <code>savePreset</code> 方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">saveOptions</span> <span class="token operator">=</span> <span class="token parameter">toSave</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">cloneDeep</span><span class="token punctuation">(</span>exports<span class="token punctuation">.</span><span class="token function">loadOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> toSave<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> exports<span class="token punctuation">.</span>defaults<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  cachedOptions <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>rcPath<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error saving preferences: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">make sure you have write access to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rcPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">savePreset</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> preset</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> presets <span class="token operator">=</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>exports<span class="token punctuation">.</span><span class="token function">loadOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>presets <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  presets<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> preset<span class="token punctuation">;</span>
  <span class="token keyword">return</span> exports<span class="token punctuation">.</span><span class="token function">saveOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>代码很简单，先深拷贝一份 Preset（这里直接用的 lodash 的 clonedeep），然后进过一些 <code>merge</code> 的操作之后就 <code>writeFileSync</code> 到上文有提到的 <code>.vuerc</code> 文件了。</p> <h2 id="_10-自定义配置加载"><a href="#_10-自定义配置加载" class="header-anchor">#</a> 10. 自定义配置加载</h2> <p>这四种 <code>prompt</code>  分别对应的是预设选项、自定义 feature 选择、具体 feature 选项和其它选项，它们之间存在互相关联、层层递进的关系。结合这四种 <code>prompt</code>，就是 Vue CLI 展现开用户面前的所有交互了，其中也包含自定义配置的加载。</p> <h3 id="_10-1-presetprompt-预设选项"><a href="#_10-1-presetprompt-预设选项" class="header-anchor">#</a> 10.1 presetPrompt: 预设选项</h3> <h4 id=""><a href="#" class="header-anchor">#</a></h4> <p>也就是最初截图里看到的哪三个选项，选择 Vue2 还是 Vue3 还是自定义 <code>feature</code>：</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/a7294bfb-45dd-41ef-9c79-3f99e3fc2d08.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=7tQgoizOPpcxVwfOBJ%252BfDYD7twM%253D&amp;Expires=1610341645" alt=""></p> <p>如果选择了 <code>Vue2</code>  或者 <code>Vue3</code> ，则后续关于 <code>preset</code>  所有的 <code>prompt</code>  都会终止。</p> <h3 id="_10-2-featureprompt-自定义-feature-选项"><a href="#_10-2-featureprompt-自定义-feature-选项" class="header-anchor">#</a> 10.2 featurePrompt: 自定义 feature 选项</h3> <p>**
如果在 <code>presetPrompt</code>  中选择了 <code>Manually</code>，则会继续选择 <code>feature</code>：
<img src="https://imgkr2.cn-bj.ufileos.com/c02bb96a-e3f1-4385-b2fb-8332b665bf8b.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=oON3vekqHcuE8x7ZhmenMyR58Kg%253D&amp;Expires=1610341666" alt=""></p> <p><code>featurePrompt</code>  就是存储的这个列表，对应的代码是这样的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">isManualMode</span> <span class="token operator">=</span> <span class="token parameter">answers</span> <span class="token operator">=&gt;</span> answers<span class="token punctuation">.</span>preset <span class="token operator">===</span> <span class="token string">'__manual__'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> featurePrompt <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'features'</span><span class="token punctuation">,</span>
  when<span class="token operator">:</span> isManualMode<span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'checkbox'</span><span class="token punctuation">,</span>
  message<span class="token operator">:</span> <span class="token string">'Check the features needed for your project:'</span><span class="token punctuation">,</span>
  choices<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  pageSize<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在代码中可以看到，在 <code>isManualMode</code>  的时候才会弹出这个交互。</p> <h3 id="_10-3-injectedprompts-具体-feature-选项"><a href="#_10-3-injectedprompts-具体-feature-选项" class="header-anchor">#</a> 10.3 injectedPrompts: 具体 feature 选项</h3> <p><code>featurePrompt</code>  只是提供了一个一级列表，当用户选择了 <code>Vue Version</code> / <code>Babel</code> / <code>TypeScript</code>  等选项之后，会弹出新的交互，比如 <code>Choose Vue version</code>：</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/95d6d96f-34f2-4f26-8419-ca401726da64.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=NqbXdRmUz3pUmubuE56krP%252Bq5QY%253D&amp;Expires=1610341683" alt=""></p> <p><code>injectedPrompts</code>  就是存储的这些具体选项的列表，也就是上文有提到通过 <code>getPromptModules</code> 方法在 <code>promptModules</code>  目录获取到的那些 <code>prompt</code>  模块：</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/90744e1a-a27d-42a5-a647-6274297b5a7e.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=UWk%252FGjl01zDKbew2L3ciGdYjOGA%253D&amp;Expires=1610341720" alt=""></p> <p>对应的代码可以再回顾一下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>cli<span class="token punctuation">.</span><span class="token function">injectPrompt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'vueVersion'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">when</span><span class="token operator">:</span> <span class="token parameter">answers</span> <span class="token operator">=&gt;</span> answers<span class="token punctuation">.</span>features<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'vueVersion'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  message<span class="token operator">:</span> <span class="token string">'Choose a version of Vue.js that you want to start the project with'</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
  choices<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'2.x'</span><span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'3.x (Preview)'</span><span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">'3'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到，在 <code>answers =&gt; answers.features.includes('vueVersion')</code>，也就是 <code>featurePrompt</code> 的交互结果中如果包含 <code>vueVersion</code>  就会弹出具体选择 <code>Vue Version</code>  的交互。</p> <h3 id="_10-4-outroprompts-其它选项"><a href="#_10-4-outroprompts-其它选项" class="header-anchor">#</a> 10.4 outroPrompts: 其它选项</h3> <p>**
这里存储的就是一些除了上述三类选项之外的选项目前包含三个：</p> <p>**Where do you prefer placing config for Babel, ESLint, etc.? **Babel，ESLint 等配置文件如何存储？</p> <ul><li><strong>In dedicated config files</strong>。单独保存在各自的配置文件中。</li> <li><strong>In package.json</strong>。统一存储在 package.json 中。</li></ul> <p>**Save this as a preset for future projects? **是否保存这次 Preset 以便之后直接使用。</p> <p>如果你选择了 Yes，则会再出来一个交互：<strong>Save preset as <strong>输入 Preset 的名称</strong>。</strong></p> <h3 id="_10-5-总结-vue-cli-交互流程"><a href="#_10-5-总结-vue-cli-交互流程" class="header-anchor">#</a> 10.5 总结：Vue CLI 交互流程</h3> <p>这里总结一下 Vue CLI 的整体交互，也就是 <code>prompt</code>  的实现。</p> <p>也就是文章最开始的时候提到，Vue CLI 支持默认配置之外，也支持自定义配置（Babel、TS 等），这样一个交互流程是如何实现的。</p> <p>Vue CLI 将所有交互分为四大类：</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/ff34a180-aa9b-4f6a-ae40-bbb6f6ad97f5.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=w%252FhT8nXVPIVRQV3IDM9JEK%252F1wa4%253D&amp;Expires=1610341755" alt=""></p> <p>从预设选项到具体 feature 选项，它们是一个<strong>层层递进</strong>的关系，不同的时机和选择会触发不同的交互。</p> <p>Vue CLI 这里在代码架构上的设计值得学习，将各个交互维护在不同的模块中，通过统一的一个 <code>prmoptAPI</code>  实例在 <code>Creator</code>  实例初始化的时候，插入到不同的 <code>prompt</code>  中，并且注册各自的回调函数。这样设计对于 <code>prompt</code>  而言是完全解耦的，删除某一项 <code>prompt</code>  对于上下文的影响可以忽略不计。</p> <p>好了，关于预设（Preset）和交互（Prompt）到这里基本分析完了，剩下的一些细节问题就不再展开了。</p> <p>这里涉及到的相关源码文件有，大家可以自行看一下：</p> <ul><li>Creator.js</li> <li>PromptModuleAPI.js</li> <li>utils/createTools.js</li> <li>promptModules</li> <li>...</li></ul> <h2 id="_11-初始化项目基础文件"><a href="#_11-初始化项目基础文件" class="header-anchor">#</a> 11. 初始化项目基础文件</h2> <p>当用户选完所有交互之后，CLI 的下一步职责就是根据用户的选项去生成对应的代码了，这也是 CLI 的核心功能之一。</p> <h3 id="_11-1-初始化-package-json-文件"><a href="#_11-1-初始化-package-json-文件" class="header-anchor">#</a> 11.1 初始化 package.json 文件</h3> <p>根据用户的选项会挂载相关的 <code>vue-cli-plugin</code>，然后用于生成 <code>package.json</code>  的依赖 <code>devDependencies</code>，比如 <code>@vue/cli-service</code> / <code>@vue/cli-plugin-babel</code> / <code>@vue/cli-plugin-eslint</code>  等。</p> <p>Vue CLI 会现在创建目录下写入一个基础的 <code>package.json</code> ：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.1.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@vue/cli-plugin-babel&quot;</span><span class="token operator">:</span> <span class="token string">&quot;~4.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@vue/cli-plugin-eslint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;~4.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@vue/cli-service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;~4.5.0&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="-2"><a href="#-2" class="header-anchor">#</a></h3> <h3 id="_11-2-初始化-git"><a href="#_11-2-初始化-git" class="header-anchor">#</a> 11.2 初始化 Git</h3> <p>根据传入的参数和一系列的判断，会在目标目录下初始化 Git 环境，简单来说就是执行一下 <code>git init</code>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'git init'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>具体是否初始化 Git 环境是这样判断的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">shouldInitGit</span><span class="token punctuation">(</span><span class="token parameter">cliOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果全局没安装 Git，则不初始化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasGit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果 CLI 有传入 --git 参数，则初始化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cliOptions<span class="token punctuation">.</span>forceGit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果 CLI 有传入 --no-git，则不初始化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cliOptions<span class="token punctuation">.</span>git <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> cliOptions<span class="token punctuation">.</span>git <span class="token operator">===</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果当前目录下已经有 Git 环境，就不初始化</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">hasProjectGit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_11-3-初始化-readme-md"><a href="#_11-3-初始化-readme-md" class="header-anchor">#</a> 11.3 初始化 README.md</h3> <p>项目的 <code>README.md</code>  会根据上下文动态生成，而不是写死的一个文档：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">generateReadme</span><span class="token punctuation">(</span><span class="token parameter">pkg<span class="token punctuation">,</span> packageManager</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"># </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pkg<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token string">'## Project setup'</span><span class="token punctuation">,</span>
    <span class="token string">'```'</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageManager<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> install</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token string">'```'</span><span class="token punctuation">,</span>
    <span class="token function">printScripts</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> packageManager<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'### Customize configuration'</span><span class="token punctuation">,</span>
    <span class="token string">'See [Configuration Reference](https://cli.vuejs.org/config/).'</span><span class="token punctuation">,</span>
    <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Vue CLI 创建的 <code>README.md</code>  会告知用户如何使用这个项目，除了 <code>npm install</code>  之外，会根据 <code>package.json</code>  里的 <code>scripts</code>  参数来动态生成使用文档，比如如何开发、构建和测试：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> descriptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  build<span class="token operator">:</span> <span class="token string">'Compiles and minifies for production'</span><span class="token punctuation">,</span>
  serve<span class="token operator">:</span> <span class="token string">'Compiles and hot-reloads for development'</span><span class="token punctuation">,</span>
  lint<span class="token operator">:</span> <span class="token string">'Lints and fixes files'</span><span class="token punctuation">,</span>
  <span class="token string">'test:e2e'</span><span class="token operator">:</span> <span class="token string">'Run your end-to-end tests'</span><span class="token punctuation">,</span>
  <span class="token string">'test:unit'</span><span class="token operator">:</span> <span class="token string">'Run your unit tests'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">printScripts</span><span class="token punctuation">(</span><span class="token parameter">pkg<span class="token punctuation">,</span> packageManager</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>scripts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>descriptions<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n### </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>descriptions<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token string">'```'</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageManager<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageManager <span class="token operator">!==</span> <span class="token string">'yarn'</span> <span class="token operator">?</span> <span class="token string">'run '</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token string">'```'</span><span class="token punctuation">,</span>
        <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里可能会有读者问，为什么不直接拷贝一个 <code>README.md</code>  文件过去呢？</p> <ul><li>第一，Vue CLI 支持不同的包管理，对应安装、启动和构建脚本都是不一样的，这个是需要动态生成的；</li> <li>第二，动态生成自由性更强，可以根据用户的选项去生成对应的文档，而不是大家都一样。</li></ul> <h3 id="_11-4-安装依赖"><a href="#_11-4-安装依赖" class="header-anchor">#</a> 11.4 安装依赖</h3> <p>调用 <code>ProjectManage</code> 的 <code>install</code> 方法安装依赖，代码不复杂：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">async</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>needsNpmInstallFix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 读取 package.json</span>
     <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">resolvePkg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span>
     <span class="token comment">// 安装 dependencies</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">const</span> deps <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>dep<span class="token punctuation">,</span> range<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dep<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>range<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
       <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> deps<span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
     <span class="token comment">// 安装 devDependencies</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>devDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">const</span> devDeps <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>devDependencies<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>dep<span class="token punctuation">,</span> range<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dep<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>range<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
       <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>devDeps<span class="token punctuation">,</span> <span class="token string">'--save-dev'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
     <span class="token comment">// 安装 optionalDependencies</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>optionalDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">const</span> devDeps <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>devDependencies<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>dep<span class="token punctuation">,</span> range<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dep<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>range<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
       <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>devDeps<span class="token punctuation">,</span> <span class="token string">'--save-optional'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>needsPeerDepsFix <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token string">'--legacy-peer-deps'</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>简单来说就是读取 <code>package.json</code> 然后分别安装 <code>npm</code> 的不同依赖。</p> <p>这里的逻辑深入进去感觉还是挺复杂的，我也没仔细深入看，就不展开说了。。。</p> <h4 id="_11-4-1-自动判断-npm-源"><a href="#_11-4-1-自动判断-npm-源" class="header-anchor">#</a> 11.4.1 自动判断 NPM 源</h4> <p>这里有一个有意思的点，关于安装依赖时使用的 npm 仓库源。<strong>如果用户没有指定安装源，Vue CLI 会自动判断是否使用淘宝的 NPM 安装源</strong>，猜猜是如何实现的？</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">shouldUseTaobao</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> faster
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    faster <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token function">ping</span><span class="token punctuation">(</span>defaultRegistry<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">ping</span><span class="token punctuation">(</span>registries<span class="token punctuation">.</span>taobao<span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>faster <span class="token operator">!==</span> registries<span class="token punctuation">.</span>taobao<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// default is already faster</span>
    <span class="token keyword">return</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> useTaobaoRegistry <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'useTaobaoRegistry'</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'confirm'</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> Your connection to the default </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>command<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> registry seems to be slow.\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">   Use </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span>registries<span class="token punctuation">.</span>taobao<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> for faster installation?</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">save</span><span class="token punctuation">(</span>useTaobaoRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Vue CLI 中会通过 <code>Promise.race</code> 去请求<strong>默认安装源</strong>和<strong>淘宝安装源：</strong>
**</p> <ul><li>如果先返回的是淘宝安装源，就会让用户确认一次，是否使用淘宝安装源</li> <li>如果先返回的是默认安装源，就会直接使用默认安装源</li></ul> <p>一般来说，肯定都是使用默认安装源，但是考虑国内用户。。咳咳。。为这个设计点赞。</p> <h2 id="_15-generator-生成代码"><a href="#_15-generator-生成代码" class="header-anchor">#</a> 15. Generator 生成代码</h2> <p>除了 <code>Creator</code>  外，整个 Vue CLI 的第二大重要的类是 <code>Generator</code>，负责项目代码的生成，来具体看看干了啥。</p> <h3 id="_15-1-初始化插件"><a href="#_15-1-初始化插件" class="header-anchor">#</a> 15.1 初始化插件</h3> <p>在 <code>generate</code>  方法中，最先执行的是一个 <code>initPlugins</code>  方法，代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token function">initPlugins</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> id <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allPluginIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GeneratorAPI</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> rootOptions<span class="token punctuation">)</span>
    <span class="token keyword">const</span> pluginGenerator <span class="token operator">=</span> <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/generator</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pluginGenerator <span class="token operator">&amp;&amp;</span> pluginGenerator<span class="token punctuation">.</span>hooks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> pluginGenerator<span class="token punctuation">.</span><span class="token function">hooks</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> rootOptions<span class="token punctuation">,</span> pluginIds<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这里会给每一个 <code>package.json</code>  里的插件初始化一个 <code>GeneratorAPI</code>  实例，将实例传入对应插件的 <code>generator</code>  方法并执行，比如 <code>@vue/cli-plugin-babel/generator.js</code>。</p> <h3 id="_15-2-generatorapi-类"><a href="#_15-2-generatorapi-类" class="header-anchor">#</a> 15.2 GeneratorAPI 类</h3> <blockquote><p>Vue CLI 使用了一套基于插件的架构。如果你查阅一个新创建项目的 package.json，就会发现依赖都是以 @vue/cli-plugin- 开头的。插件可以修改 webpack 的内部配置，也可以向 vue-cli-service 注入命令。在项目创建的过程中，绝大部分列出的特性都是通过插件来实现的。</p></blockquote> <p>刚刚提到，会往每一个插件的 <code>generator</code>  中传入 <code>GeneratorAPI</code>  的实例，看看这个类提供了什么。</p> <h4 id="_15-2-1-例子-vue-cli-plugin-babel"><a href="#_15-2-1-例子-vue-cli-plugin-babel" class="header-anchor">#</a> 15.2.1 例子：@vue/cli-plugin-babel</h4> <p>为了不那么抽象，我们先拿 <code>@vue/cli-plugin-babel</code> 来看，这个插件比较简单：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">api</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">delete</span> api<span class="token punctuation">.</span>generator<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'babel.config.js'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    babel<span class="token operator">:</span> <span class="token punctuation">{</span>
      presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@vue/cli-plugin-babel/preset'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    dependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'core-js'</span><span class="token operator">:</span> <span class="token string">'^3.6.5'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这里 <code>api</code>  就是一个 <code>GeneratorAPI</code> 实例，这里用到了一个 <code>extendPackage</code>  方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// GeneratorAPI.js</span>
<span class="token comment">// 删减部分代码，只针对 @vue/cli-plugin-babel 分析</span>
<span class="token function">extendPackage</span> <span class="token punctuation">(</span><span class="token parameter">fields<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>pkg
  <span class="token keyword">const</span> toMerge <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">fields</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span> <span class="token operator">:</span> fields
  <span class="token comment">// 遍历传入的参数，这里是 babel 和 dependencies 两个对象</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> toMerge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> toMerge<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">const</span> existing <span class="token operator">=</span> pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token comment">// 如果 key 的名称是 dependencies 和 devDependencies</span>
    <span class="token comment">// 就通过 mergeDeps 方法往 package.json 合并依赖</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'dependencies'</span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token string">'devDependencies'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">mergeDeps</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        existing <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        value<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>depSources<span class="token punctuation">,</span>
        extendOptions
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>extendOptions<span class="token punctuation">.</span>merge <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> pkg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这时候，默认的 <code>package.json</code>  就变成：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;babel&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;@vue/cli-plugin-babel/preset&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;core-js&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.6.5&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.1.0&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看完这个例子，对于 <code>GeneratorAPI</code>  的实例做什么可能有些了解了，我们就来具体看看这个类的实例吧。</p> <h4 id="_15-2-2-重要的几个实例方法"><a href="#_15-2-2-重要的几个实例方法" class="header-anchor">#</a> 15.2.2 重要的几个实例方法</h4> <p>先介绍几个 <code>GeneratorAPI</code>  重要的实例方法，这里就只介绍功能，具体代码就不看了，等等会用到。</p> <ul><li><strong>extendPackage</strong>：拓展 package.json 配置</li> <li><strong>render</strong>：通过 ejs 渲染模板文件</li> <li><strong>onCreateComplete</strong>: 注册文件写入硬盘之后的回调</li> <li><strong>genJSConfig</strong>: 将 json 文件输出成 js 文件</li> <li><strong>injectImports</strong>: 向文件中加入 import</li> <li>...</li></ul> <h3 id="_16-vue-cli-service"><a href="#_16-vue-cli-service" class="header-anchor">#</a> 16. @vue/cli-service</h3> <p>上文已经看过一个 <code>@vue/cli-plugin-babel</code>  插件，对于 Vue CLI 的插件架构是不是有点感觉？也了解到一个比较重要的 <code>GeneratorAPI</code>  类，插件中的一些修改配置的功能都是这个类的实例方法。</p> <p>接下来看一个比较重要的插件 <code>@vue/cli-service</code>，这个插件是 Vue CLI 的核心插件，和 <code>create react app</code>  的 <code>react-scripts</code>  类似，借助这个插件，我们应该能够更深刻地理解 <code>GeneratorAPI</code> 以及 Vue CLI 的插件架构是如何实现的。</p> <p>来看一下 <code>@vue/cli-service</code>  这个包下的 <code>generator/index.js</code>  文件，这里为了分析方便，将源码拆解成多段，其实也就是分别调用了 <code>GeneratorAPI</code>  实例的不同方法：</p> <h4 id="_16-1-渲染-template"><a href="#_16-1-渲染-template" class="header-anchor">#</a> 16.1 渲染 template</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>api<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'./template'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  doesCompile<span class="token operator">:</span> api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'babel'</span><span class="token punctuation">)</span> <span class="token operator">||</span> api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'typescript'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将 <code>template</code>  目录下的文件通过 <code>render</code>  渲染到内存中，这里用的是 <code>ejs</code>  作为模板渲染引擎。</p> <h4 id="_16-2-写-package-json"><a href="#_16-2-写-package-json" class="header-anchor">#</a> 16.2 写 package.json</h4> <p>通过 <code>extendPackage</code> 往 <code>pacakge.json</code> 中写入 <code>Vue</code>   的相关依赖：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>vueVersion <span class="token operator">===</span> <span class="token string">'3'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    dependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
      vue<span class="token operator">:</span> <span class="token string">'^3.0.0'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    devDependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'@vue/compiler-sfc'</span><span class="token operator">:</span> <span class="token string">'^3.0.0'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    dependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
      vue<span class="token operator">:</span> <span class="token string">'^2.6.11'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    devDependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'vue-template-compiler'</span><span class="token operator">:</span> <span class="token string">'^2.6.11'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过 <code>extendPackage</code> 往 <code>pacakge.json</code> 中写入 <code>scripts</code>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  scripts<span class="token operator">:</span> <span class="token punctuation">{</span>
    serve<span class="token operator">:</span> <span class="token string">'vue-cli-service serve'</span><span class="token punctuation">,</span>
    build<span class="token operator">:</span> <span class="token string">'vue-cli-service build'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  browserslist<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'&gt; 1%'</span><span class="token punctuation">,</span> <span class="token string">'last 2 versions'</span><span class="token punctuation">,</span> <span class="token string">'not dead'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过 <code>extendPackage</code> 往 <code>pacakge.json</code> 中写入 <code>CSS</code> 预处理参数：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>cssPreprocessor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> deps <span class="token operator">=</span> <span class="token punctuation">{</span>
    sass<span class="token operator">:</span> <span class="token punctuation">{</span>
      sass<span class="token operator">:</span> <span class="token string">'^1.26.5'</span><span class="token punctuation">,</span>
      <span class="token string">'sass-loader'</span><span class="token operator">:</span> <span class="token string">'^8.0.2'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'node-sass'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'node-sass'</span><span class="token operator">:</span> <span class="token string">'^4.12.0'</span><span class="token punctuation">,</span>
      <span class="token string">'sass-loader'</span><span class="token operator">:</span> <span class="token string">'^8.0.2'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'dart-sass'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      sass<span class="token operator">:</span> <span class="token string">'^1.26.5'</span><span class="token punctuation">,</span>
      <span class="token string">'sass-loader'</span><span class="token operator">:</span> <span class="token string">'^8.0.2'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    less<span class="token operator">:</span> <span class="token punctuation">{</span>
      less<span class="token operator">:</span> <span class="token string">'^3.0.4'</span><span class="token punctuation">,</span>
      <span class="token string">'less-loader'</span><span class="token operator">:</span> <span class="token string">'^5.0.0'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    stylus<span class="token operator">:</span> <span class="token punctuation">{</span>
      stylus<span class="token operator">:</span> <span class="token string">'^0.54.7'</span><span class="token punctuation">,</span>
      <span class="token string">'stylus-loader'</span><span class="token operator">:</span> <span class="token string">'^3.0.2'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    devDependencies<span class="token operator">:</span> deps<span class="token punctuation">[</span>options<span class="token punctuation">.</span>cssPreprocessor<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_16-3-调用-router-插件和-vuex-插件"><a href="#_16-3-调用-router-插件和-vuex-插件" class="header-anchor">#</a> 16.3 调用 router 插件和 vuex 插件</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// for v3 compatibility</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>router <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'router'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> options<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// for v3 compatibility</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>vuex <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'vuex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./vuex'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> options<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>是不是很简单，通过 <code>GeneratorAPI</code>  提供的实例方法，可以在插件中非常方便地对项目进行修改和自定义。</p> <h2 id="_17-抽取单独配置文件"><a href="#_17-抽取单独配置文件" class="header-anchor">#</a> 17. 抽取单独配置文件</h2> <p>上文提到，通过 <code>extendPackage</code>  回往 <code>package.json</code>  中写入一些配置。但是，上文也提到有一个交互是 <strong>Where do you prefer placing config for Babel, ESLint, etc.?</strong> 也就是会将配置抽取成单独的文件。<code>generate</code>  里的 <code>extractConfigFiles</code>  方法就是执行了这个逻辑。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">extractConfigFiles</span><span class="token punctuation">(</span><span class="token parameter">extractAll<span class="token punctuation">,</span> checkExisting</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> configTransforms <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    defaultConfigTransforms<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>configTransforms<span class="token punctuation">,</span>
    reservedConfigTransforms
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">extract</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      configTransforms<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>originalPkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> configTransform <span class="token operator">=</span> configTransforms<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> configTransform<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>
        value<span class="token punctuation">,</span>
        checkExisting<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> content<span class="token punctuation">,</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> res<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ensureEOL</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>extractAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">extract</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">extract</span><span class="token punctuation">(</span><span class="token string">&quot;babel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的 <code>configTransforms</code>  就是一些会需要抽取的配置：</p> <p><img src="https://imgkr2.cn-bj.ufileos.com/b4679fb3-48da-472f-8df2-5125e0b405ec.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&amp;Signature=isxubkhUi1Lul1soXWZ4GzDUnqM%253D&amp;Expires=1610341790" alt=""></p> <p>如果 <code>extractAll</code>  是 <code>true</code>，也就是在上面的交互中选了 Yes，就会将 <code>package.json</code>  里的所有 <code>key</code> <code>configTransforms</code> 比较，如果都存在，就将配置抽取到独立的文件中。</p> <h2 id="_18-将内存中的文件输出到硬盘"><a href="#_18-将内存中的文件输出到硬盘" class="header-anchor">#</a> 18. 将内存中的文件输出到硬盘</h2> <p>上文有提到，<code>api.render</code>  会通过 EJS 将模板文件渲染成字符串放在内存中。执行了 <code>generate</code>  的所有逻辑之后，内存中已经有了需要输出的各种文件，放在 <code>this.files</code>  里。 <code>generate</code>  的最后一步就是调用 <code>writeFileTree</code>  将内存中的所有文件写入到硬盘。</p> <p>到这里 <code>generate</code>  的逻辑就基本都讲完了，Vue CLI 生成代码的部分也就讲完了。</p> <h2 id="_19-总结"><a href="#_19-总结" class="header-anchor">#</a> 19. 总结</h2> <p>整体看下来，Vue CLI 的代码还是比较复杂的，整体架构条理还是比较清楚的，其中有两点印象最深：</p> <p><strong>第一，整体的交互流程的挂载</strong>。将各个模块的交互逻辑通过一个类的实例维护起来，执行时机和成功回调等也是设计的比较好。</p> <p><strong>第二，插件机制很重要</strong>。插件机制将功能和脚手架进行解耦。</p> <p>看来，无论是 create-react-app 还是 Vue CLI，在设计的时候都会尽量考虑<strong>插件机制</strong>，将能力开放出去再将功能集成进来，无论是对于 Vue CLI 本身的核心功能，还是对于社区开发者来说，都具备了足够的开放性和扩展性。</p> <p>整体代码看下来，最重要的就是两个概念：</p> <ul><li><strong>Preset</strong>：预设，包括整体的交互流程（Prompt）</li> <li><strong>Plugin</strong>：插件，整体的插件系统</li></ul> <p>围绕这两个概念，代码中的这几个类：<strong>Creator</strong>、<strong>PromptModuleAPI</strong>、<strong>Generator</strong>、<strong>GeneratorAPI</strong> 就是核心。</p> <p>简单总结一下流程：</p> <ol><li>执行 <code>vue create</code></li> <li>初始化 <code>Creator</code> 实例 <code>creator</code>，挂载所有交互配置</li> <li>调用 <code>creator</code> 的实例方法 <code>create</code></li> <li>询问用户自定义配置</li> <li>初始化 <code>Generator</code> 实例 <code>generator</code></li> <li>初始化各种插件</li> <li>执行插件的 <code>generator</code> 逻辑，写 <code>package.json</code>、渲染模板等</li> <li>将文件写入到硬盘</li></ol> <p>这样一个 CLI 的生命周期就走完了，项目已经初始化好了。</p> <h2 id="附-vue-cli-中可以直接拿来用的工具方法"><a href="#附-vue-cli-中可以直接拿来用的工具方法" class="header-anchor">#</a> 附：Vue CLI 中可以直接拿来用的工具方法</h2> <p>看完 Vue CLI 的源码，除了感叹这复杂的设计之外，也发现很多工具方法，在我们实现自己的 CLI 时，都是可以拿来即用的，在这里总结一下。</p> <h3 id="获取-cli-参数"><a href="#获取-cli-参数" class="header-anchor">#</a> 获取 CLI 参数</h3> <p>解析 CLI 通过 <code>--</code> 传入的参数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">camelize</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">-(\w)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>c <span class="token operator">?</span> c<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">cleanArgs</span><span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  cmd<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">o</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">camelize</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>long<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^--</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// if an option is not present and Command has a method with the same name</span>
    <span class="token comment">// it should not be copied</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> cmd<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> cmd<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      args<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> cmd<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> args<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="检查-node-版本"><a href="#检查-node-版本" class="header-anchor">#</a> 检查 Node 版本</h3> <p>通过 <code>semver.satisfies</code> 比较两个 Node 版本：</p> <ul><li><strong>process.version</strong>: 当前运行环境的 Node 版本</li> <li><strong>wanted: package.json</strong> 里配置的 Node 版本</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> requiredVersion <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>engines<span class="token punctuation">.</span>node<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">checkNodeVersion</span><span class="token punctuation">(</span><span class="token parameter">wanted<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>semver<span class="token punctuation">.</span><span class="token function">satisfies</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>version<span class="token punctuation">,</span> wanted<span class="token punctuation">,</span> <span class="token punctuation">{</span> includePrerelease<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span>
        <span class="token string">'You are using Node '</span> <span class="token operator">+</span>
          process<span class="token punctuation">.</span>version <span class="token operator">+</span>
          <span class="token string">', but this version of '</span> <span class="token operator">+</span>
          id <span class="token operator">+</span>
          <span class="token string">' requires Node '</span> <span class="token operator">+</span>
          wanted <span class="token operator">+</span>
          <span class="token string">'.\nPlease upgrade your Node version.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">checkNodeVersion</span><span class="token punctuation">(</span>requiredVersion<span class="token punctuation">,</span> <span class="token string">'@vue/cli'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="读取-package-json"><a href="#读取-package-json" class="header-anchor">#</a> 读取 package.json</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getPackageJson</span><span class="token punctuation">(</span><span class="token parameter">cwd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> packagePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> packageJson<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    packageJson <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>packagePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The package.json file at '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packagePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' does not exist</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    packageJson <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>packageJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'The package.json is malformed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> packageJson<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="对象排序"><a href="#对象排序" class="header-anchor">#</a> 对象排序</h3> <p>这里主要是在输出 package.json 的时候可以对输出的对象先进行排序，更美观一些。。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">sortObject</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> keyOrder<span class="token punctuation">,</span> dontSortByUnicode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>keyOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    keyOrder<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">!</span>dontSortByUnicode <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="输出文件到硬盘"><a href="#输出文件到硬盘" class="header-anchor">#</a> 输出文件到硬盘</h3> <p>这个其实没啥，就是三步：</p> <ul><li>fs.unlink 删除文件</li> <li>fs.ensureDirSync 创建目录</li> <li>fs.writeFileSync 写文件</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-extra'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 删除已经存在的文件</span>
<span class="token keyword">function</span> <span class="token function">deleteRemovedFiles</span><span class="token punctuation">(</span><span class="token parameter">directory<span class="token punctuation">,</span> newFiles<span class="token punctuation">,</span> previousFiles</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// get all files that are not in the new filesystem and are still existing</span>
  <span class="token keyword">const</span> filesToDelete <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>previousFiles<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
    <span class="token parameter">filename</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>newFiles<span class="token punctuation">[</span>filename<span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// delete each of these files</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    filesToDelete<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">filename</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>directory<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 输出文件到硬盘</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">writeFileTree</span><span class="token punctuation">(</span><span class="token parameter">dir<span class="token punctuation">,</span> files<span class="token punctuation">,</span> previousFiles</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>previousFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">deleteRemovedFiles</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> files<span class="token punctuation">,</span> previousFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 主要就是这里</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">ensureDirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> files<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="判断项目是否初始化-git"><a href="#判断项目是否初始化-git" class="header-anchor">#</a> 判断项目是否初始化 git</h3> <p>其实就是在目录下执行 <code>git status</code> 看是否报错。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">hasProjectGit</span> <span class="token operator">=</span> <span class="token parameter">cwd</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git status'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token operator">:</span> <span class="token string">'ignore'</span><span class="token punctuation">,</span> cwd <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="对象的-get-方法"><a href="#对象的-get-方法" class="header-anchor">#</a> 对象的 get 方法</h3> <p>可以用 lodash，现在可以直接用 a?.b?.c 就好了</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fields <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> target<span class="token punctuation">;</span>
  <span class="token keyword">const</span> l <span class="token operator">=</span> fields<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    obj <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">[</span>fields<span class="token punctuation">[</span>l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="article-footer" data-v-4713b8bc><div role="separator" class="ant-divider ant-divider-horizontal" data-v-4713b8bc></div> <p data-v-4713b8bc>
    关注公众号
    <span class="bold" data-v-4713b8bc>玩相机的程序员</span></p> <p data-v-4713b8bc>原创文章持续更新中</p> <img src="/articles/assets/img/qrcode.jpg" data-v-4713b8bc> <p data-v-4713b8bc>我是 axuebin，用键盘和相机记录生活</p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/articles/fe-solution/cli/cra.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        create-react-app 核心思路分析
      </a></span> <span class="next"><a href="/articles/fe-solution/babel/first.html">
        初学 Babel 工作原理
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> </main> <!----></div><div class="global-ui"><div class="right-group" data-v-63a47ae2><div class="item" data-v-63a47ae2><div class="title" data-v-63a47ae2>关注微信公众号</div> <div class="desc" data-v-63a47ae2>高质量原创文章</div> <img src="/articles/assets/img/qrcode.jpg" alt="玩相机的程序员" title="玩相机的程序员" data-v-63a47ae2></div> <div class="item" data-v-63a47ae2><div class="title" data-v-63a47ae2>加入前端划水群</div> <div class="desc" data-v-63a47ae2>
      扫码备注
      <span class="red" data-v-63a47ae2>加群</span></div> <img src="/articles/assets/img/wechat.jpg" alt="axuebin" title="axuebin" data-v-63a47ae2></div></div></div></div>
    <script src="/articles/assets/js/app.3cef7185.js" defer></script><script src="/articles/assets/js/2.8d419c10.js" defer></script><script src="/articles/assets/js/20.ac770832.js" defer></script><script src="/articles/assets/js/3.97f21fa0.js" defer></script><script src="/articles/assets/js/4.3f1e58e8.js" defer></script>
  </body>
</html>